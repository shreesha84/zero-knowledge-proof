<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZKML: Separated Roles</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; background: #f0f2f5; }
        .container { display: flex; gap: 20px; }
        .card { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1; }
        h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .prover { border-top: 5px solid #007bff; }
        .verifier { border-top: 5px solid #28a745; }
        
        input[type="number"] { width: 60px; padding: 5px; }
        button { width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-prove { background: #007bff; color: white; }
        .btn-verify { background: #28a745; color: white; }
        .btn-prove:disabled, .btn-verify:disabled { background: #ccc; }

        .file-upload { margin-top: 15px; padding: 10px; background: #f9f9f9; border: 1px dashed #ccc; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        
        #status { margin-top: 20px; padding: 15px; border-radius: 5px; text-align: center; font-weight: bold; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <h1>ZKML Trustless Verification Demo</h1>

    <div class="container">
        <div class="card prover">
            <h2>üïµÔ∏è Prover (Uploader)</h2>
            <p>I have the private model and private data.</p>
            <p><b>Input Secret Data:</b></p>
            <div>
                <input type="number" id="v1" value="0.1" step="0.1">
                <input type="number" id="v2" value="0.2" step="0.1">
                <input type="number" id="v3" value="0.3" step="0.1">
            </div>
            <button class="btn-prove" onclick="generateAndDownload()">1. Generate Proof & Keys</button>
            <p style="font-size: 0.8rem; color: #666;">*This will download proof.json and vk.key to your computer.</p>
        </div>

        <div class="card verifier">
            <h2>‚öñÔ∏è Verifier (Public)</h2>
            <p>I don't have the model. I only trust the math.</p>
            
            <div class="file-upload">
                <label>Upload Proof (proof.json)</label>
                <input type="file" id="proofFile">
            </div>

            <div class="file-upload">
                <label>Upload Key (vk.key)</label>
                <input type="file" id="vkFile">
            </div>

            <button class="btn-verify" onclick="verifyUploaded()">2. Verify Proof</button>
        </div>
    </div>

    <div id="status"></div>

    <script>
        const API_URL = "http://127.0.0.1:8000";

        // Helper to trigger file downloads
        function downloadFile(filename, content, isBinary = false) {
            const element = document.createElement('a');
            if (isBinary) {
                // Convert base64 to blob
                const byteCharacters = atob(content);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], {type: "application/octet-stream"});
                element.href = URL.createObjectURL(blob);
            } else {
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(JSON.stringify(content, null, 2)));
            }
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        async function generateAndDownload() {
            const btn = document.querySelector('.btn-prove');
            btn.disabled = true;
            btn.innerText = "Generating...";

            try {
                const data = {
                    data: [
                        parseFloat(document.getElementById('v1').value),
                        parseFloat(document.getElementById('v2').value),
                        parseFloat(document.getElementById('v3').value)
                    ]
                };

                const res = await fetch(`${API_URL}/prove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                
                // 1. Download Proof
                downloadFile('proof.json', result.proof);
                
                // 2. Download VK (Binary)
                // Small delay to ensure browser handles both downloads
                setTimeout(() => downloadFile('vk.key', result.vk, true), 500);

                alert("Proof and Key generated! Check your downloads folder.");

            } catch (err) {
                alert("Error: " + err);
            } finally {
                btn.disabled = false;
                btn.innerText = "1. Generate Proof & Keys";
            }
        }

        async function verifyUploaded() {
            const btn = document.querySelector('.btn-verify');
            const status = document.getElementById('status');
            const proofInput = document.getElementById('proofFile');
            const vkInput = document.getElementById('vkFile');

            if (!proofInput.files[0] || !vkInput.files[0]) {
                alert("Please upload both proof.json and vk.key");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Verifying...";
            status.style.display = 'none';

            const formData = new FormData();
            formData.append('proof_file', proofInput.files[0]);
            formData.append('vk_file', vkInput.files[0]);

            try {
                const res = await fetch(`${API_URL}/verify`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await res.json();

                status.style.display = 'block';
                if (result.is_valid) {
                    status.innerText = "‚úÖ VALID: The proof matches the key. The computation is correct.";
                    status.className = "success";
                } else {
                    status.innerText = "‚ùå INVALID: The proof does not match the key.";
                    status.className = "error";
                }

            } catch (err) {
                alert("Error: " + err);
            } finally {
                btn.disabled = false;
                btn.innerText = "2. Verify Proof";
            }
        }
    </script>
</body>
</html>
